# 시나리오 분석 및 문제 정의

## 1. 문제 정의

### 핵심 문제
**동시성이 고려된 안전한 e-커머스 상품 주문 시스템 구축**

### 세부 문제
1. **동시성 이슈**: 다수의 사용자가 동시에 주문할 때 잔액 차감 및 재고 관리의 정확성 보장
2. **재고 관리**: 상품 재고량을 실시간으로 정확하게 관리하여 초과 판매 방지
3. **데이터 일관성**: 주문-결제-재고 간 데이터 무결성 유지
4. **확장성**: 다중 인스턴스 환경에서의 안정적인 동작

## 2. 요구사항 분석

### 2.1 기능적 요구사항

#### 사용자 관리
- 사용자는 잔액을 충전할 수 있다
- 사용자는 현재 잔액을 조회할 수 있다

#### 상품 관리  
- 시스템은 상품 목록을 제공한다
- 각 상품은 이름, 가격, 재고 정보를 가진다

#### 주문 관리
- 사용자는 여러 상품을 선택하여 주문할 수 있다
- 주문 시 사용자의 잔액으로 결제가 진행된다
- 결제 완료 후 재고가 차감된다

#### 통계 관리
- 최근 3일간 판매량 기준 상위 5개 상품을 조회할 수 있다

#### 외부 연동
- 주문 정보를 실시간으로 외부 데이터 플랫폼에 전송한다

### 2.2 비기능적 요구사항

#### 성능 요구사항
- **동시성**: 100명의 사용자가 동시에 같은 상품을 주문해도 재고 오버플로우 발생 안함
- **응답시간**: API 응답시간 500ms 이하
- **처리량**: 초당 1000건의 주문 처리 가능

#### 안정성 요구사항
- **데이터 무결성**: ACID 트랜잭션 보장
- **오류 복구**: 결제 실패 시 자동 롤백
- **멱등성**: 동일한 주문 요청의 중복 처리 방지

#### 확장성 요구사항
- **수평 확장**: 다중 서버 인스턴스 지원
- **로드 밸런싱**: 서버 간 부하 분산
- **캐싱**: 조회 성능 최적화

## 3. 시나리오 상세 분석

### 3.1 사용자 여정 (User Journey)

```
사용자 등록/로그인 → 잔액 충전 → 상품 조회 → 상품 선택 → 주문 생성 → 결제 → 주문 완료
```

### 3.2 핵심 시나리오

#### 시나리오 1: 정상 주문 프로세스
```
Given: 사용자 A가 10,000원의 잔액을 보유하고 있다
And: 상품 X의 재고가 5개 있고 가격이 3,000원이다
When: 사용자 A가 상품 X를 2개 주문한다
Then: 
  - 사용자 A의 잔액은 4,000원이 된다
  - 상품 X의 재고는 3개가 된다  
  - 주문이 생성되고 완료 상태가 된다
  - 외부 데이터 플랫폼에 주문 정보가 전송된다
```

#### 시나리오 2: 동시성 이슈 시나리오 
```
Given: 사용자 A, B가 각각 10,000원의 잔액을 보유하고 있다
And: 상품 Y의 재고가 1개 있고 가격이 5,000원이다
When: 사용자 A와 B가 동시에 상품 Y를 1개씩 주문한다
Then: 
  - 한 명의 사용자만 주문에 성공한다
  - 다른 사용자는 재고 부족 오류를 받는다
  - 재고는 정확히 0개가 된다
```

#### 시나리오 3: 잔액 부족 시나리오
```
Given: 사용자 C가 3,000원의 잔액을 보유하고 있다  
And: 상품 Z의 가격이 5,000원이다
When: 사용자 C가 상품 Z를 주문한다
Then:
  - 잔액 부족 오류가 발생한다
  - 주문이 생성되지 않는다
  - 재고는 변경되지 않는다
```

## 4. 기술적 고려사항

### 4.1 동시성 제어 방안
- **비관적 락(Pessimistic Lock)**: 재고 수량 업데이트 시 사용
- **낙관적 락(Optimistic Lock)**: 사용자 잔액 업데이트 시 사용  
- **분산 락(Distributed Lock)**: Redis를 활용한 다중 인스턴스 간 동기화

### 4.2 트랜잭션 설계
- **@Transactional**: Spring의 선언적 트랜잭션 관리
- **격리 수준**: READ_COMMITTED 사용으로 성능과 일관성 균형
- **전파 속성**: REQUIRED로 트랜잭션 경계 명확화

### 4.3 데이터 플랫폼 연동
- **비동기 처리**: 주문 완료 후 별도 스레드에서 데이터 전송
- **재시도 메커니즘**: 전송 실패 시 지수 백오프 재시도
- **Circuit Breaker**: 외부 시스템 장애 시 서비스 보호

## 5. 성공 지표

### 5.1 정확성 지표
- 동시 주문 시 재고 오차율: 0%
- 잔액 계산 정확도: 100%
- 데이터 무결성 오류율: 0%

### 5.2 성능 지표  
- API 평균 응답 시간: < 500ms
- 동시 사용자 처리량: > 100 TPS
- 시스템 가용률: > 99.9%

### 5.3 비즈니스 지표
- 주문 성공률: > 95%
- 인기상품 조회 정확도: 100%
- 외부 데이터 전송 성공률: > 99%